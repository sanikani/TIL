# 5. 로그인 처리 - 쿠키, 세션

패키지 구조 설계

- domain
    - item
    - member
    - login
- web
    - item
    - member
    - login

**도메인이 가장 중요하다.**

도메인: 화면, UI, 기술 인프라 등등의 영역은 제외한 시스템이 구현해야 하는 핵심 비즈니스 업무 영역을 말함.

향후 web을 다른 기술로 바꾸어도 도메인은 그대로 유지할 수 있어야 함.

web은 domain을 의존하지만 domain은 web을 의존하지 않는다. domain은 web을 참조하면 안된다.

### 로그인 처리하기 - 쿠키 사용

서버에서 로그인에 성공하면 HTTP 응답에 쿠키를 담아서 브라우저에 전달한다. 그러면 브라우저는 앞으로 해당 쿠키를 지속해서 보내준다.

쿠키에는 영속 쿠키와 세션 쿠키가 있다.

- 영속 쿠키: 만료 날짜를 입력하면 해당 날짜까지 유지
- 세션 쿠키: 만료 날짜를 생략하면 브라우저 종료시 까지만 유지

로그인에 성공하면 쿠키를 생성하고 HttpServletRequest에 담는다.

### 로그아웃 기능

로그아웃 방법은 다음과 같다.

- 세션 쿠키이므로 웹 브라우저 종료시
- 서버에서 해당 쿠키의 종료 날짜를 0으로 지정

### 쿠키와 보안 문제

**보안 문제**

- 쿠키 값은 임의로 변경할 수 있다.
- 쿠키에 저장된 정보는 훔쳐갈 수 있다.
- 해커카 쿠키를 한번 훔쳐가면 평생 사용할 수 있다.

**대안**

- 쿠키에 중요한 값을 노출하지 않고, 사용자 별로 예측 불가능한 임의의 토큰을 노출하고, 서버에서 토큰과 사용자 id를 매핑해서 인식한다. 그리고 서버에서 토큰을 관리한다.
- 토큰은 해커가 임의의 값을 넣어도 찾을 수 없도록 예상 불가능 해야 함.
- 토큰의 만료 시간을 짧게 유지한다. 또는 해킹이 의심되는 경우 서버에서 해당 토큰을 강제로 제거한다.

### 로그인 처리하기 - 세션 동작 방식

사용자가 로그인 정보를 전달하면 서버에서 해당 사용자가 맞는지 확인하고 세션을 생성한다. 세션 ID는 추정이 불가하도록 생성하고 생성된 세션 ID와 세션에 보관할 값을 서버의 세션 저장소에 보관한다.

세션 ID를 응답 쿠키로 전달한다. 클라이언트는 쿠키 저장소에 세션ID를 보관한다.

여기서 중요한 포인트는 회원과 관련된 정보는 전혀 클라이언트에 전달하지 않는다는 것이다.

추정 불가능한 세션 ID만 쿠키를 통해 클라이언트에 전달한다.

클라이언트는 요청시 항상 세션ID 쿠키를 전달한다. 서버는 클라이언트가 전달한 쿠키 정보로 세션 저장소를 조회해서 로그인시 보관한 세션 정보를 사용한다.

### 로그인 처리하기 - 서블릿 HTTP 세션1

서블릿은 세션을 위해 HttpSession이라는 기능을 제공한다.

**HttpSession**

서블릿을 통해 HttpSession을 생성하면 다음과 같은 쿠키를 생성한다. 쿠키 이름이 JSESSIONID이고, 값은 추정 불가능한 랜덤 값이다.

Cookie: JSESSIONID=5B78E23B513F50164D6FDD8C97B0AD05

**세션 생성과 조회**

세션을 생성하려면 HttpServletRequest의 getSession(true)를 사용하면 된다.

public HttpSession getSession(boolean create);

세션의 create 옵션

- request.getSession(true)
    - 세션이 있으면 기존 세션을 반환.
    - 세션이 없으면 새로운 세션을 생성해서 반환.
- request.getSession(false)
    - 세션이 있으면 기존 세션을 반환.
    - 세션이 없으면 새로운 세션을 생성하지 않고 null 반환.

**세션에 로그인 회원 정보 보관**

session.setAttribute(String name, Object value);

하나의 세션에 여러 값을 저장할 수 있다.

session.invalidate(): 세션을 제거한다.

### 로그인 처리하기 - 서블릿 HTTP 세션2

**@SessionAttribute**

스프링은 세션을 더 편리하게 사용할 수 있도록 지원한다.

이미 로그인 된 사용자를 찾을 때는 다음과 같이 사용하면 된다. 참고로 이 기능은 세션을 생성하지 않는다.

@SessionAttribute(name = "loginMember", required = false) Member loginMember