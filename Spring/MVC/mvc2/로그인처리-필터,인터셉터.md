# 6. 로그인 처리 - 필터, 인터셉터

### 서블릿 필터

**공통 관심 사항**

애플리케이션 여러 로직에서 공통으로 관심이 있는 것을 공통 관심사라고 한다. 이러한 공통 관심사는 스프링의 AOP로도 해결할 수 있지만, 웹과 관련된 공통 관심사는 서블릿 필터 또는 스프링 인터셉터를 사용하는 것이 좋다. 웹과 관련된 공통 관심사를 처리할 때는 HTTP의 헤더나 URL의 정보들이 필요한데, 서블릿 필터나 스프링 인터셉터는 HttpServletRequest를 제공한다.

**서블릿 필터**

**필터 흐름**

HTTP 요청 → WAS → 필터 → 서블릿 → 컨트롤러

필터를 적용하면 필터가 호출 된 다음에 서블릿이 호출된다. 참고로 스프링을 사용하는 경우 여기서 말하는 서블릿은 스프링의 디스패처 서블릿으로 생각하면 된다.

**필터 제한**

HTTP 요청 → WAS → 필터 → 서블릿 → 컨트롤러 //로그인 사용자

HTTP 요청 → WAS → 필터(적절하지 않은 요청이라 판단, 서블릿 호출X) //비 로그인 사용자

**필터 체인**

HTTP 요청 → WAS → 필터1 → 필터2 → 필터3 → 서블릿 → 컨트롤러

필터는 체인으로 구성되는데, 중간에 필터를 자유롭게 추가할 수 있다.

필터를 사용하려면 필터 인터페이스를 구현해야 한다.

- doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
    - HTTP 요청이 오면  doFilter 호출

### **스프링 인터셉터**

**스프링 인터셉터 흐름**

HTTP 요청 → WAS → 필터 → 서블릿 → 스프링 인터셉터 → 컨트롤러

- 디스패처 서블릿과 컨트롤러 사이에서 컨트롤러 호출 직전에 호출됨.
- URL 패턴 적용 가능. 매우 정밀하게 설정 가능

서블릿 필터와 호출되는 순서만 다르고 제공하는 기능은 비슷하다. 스프링 인터셉터는 서블릿 필터보다 편리하고, 더 정교하고 다양한 기능을 제공한다.

스프링의 인터셉터를 사용하려면 HandlerInterceptor 인터페이스를 구현하면 된다.

- 서블릿 필터의 경우 doFilter()만 제공된다. 인터셉터는 컨트롤러 호출 전, 호출 후, 요청 완료 이후와 같이 단계적으로 잘 세분화 되어 있다.
- 서블릿 필터의 경우 단순히 request, response만 제공했지만, 인터셉터는 어떤 컨트롤러가 호출되는지 호출 정보도 받을 수 있다. 그리고 어떤 modelAndView가 반환되는지 응답 정보도 받을 수 있다.

**스프링 인터셉터 호출 흐름**

![Untitled](/assets/mvc2-1.png)

**정상 흐름**

- preHandle: 컨트롤러 호출 전에 호출된다.(더 정확히는 핸들러 어댑터 호출 전에 호출된다)
    - preHandle의 응답값이 true이면 다음으로 진행하고, false이면 더는 진행하지 않는다. false인 경우 나머지 인터셉터는 물론이고, 핸들러 어댑터도 호출되지 않는다
- postHandle: 컨트롤러 호출 후에 호출된다.
- afterComplition: 뷰가 렌더링 된 이후에 호출된다.